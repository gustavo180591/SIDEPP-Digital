# ===========================================
# Docker Compose para SIDEPP-Digital
# Versión: Producción (servidor VPS)
# ===========================================
#
# Uso:
#   docker compose up -d --build
#
# La base de datos PostgreSQL debe estar corriendo
# externamente (no incluida en este compose).
#
# IMPORTANTE: Los archivos se guardan en ../data/
# (fuera del contenedor, en el servidor físico)
# ===========================================

name: sidepp-digital

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: prod
    container_name: sidepp_app
    environment:
      NODE_ENV: production
      PORT: 3000
      HOST: 0.0.0.0
      ORIGIN: ${ORIGIN:-http://vps-5478319-x.dattaweb.com:3000}
      DATABASE_URL: ${DATABASE_URL}
      JWT_SECRET: ${JWT_SECRET}
      FILE_STORAGE_DIR: /data
      UPLOAD_DIR: /data/uploads
      EXTRACTION_DIR: /data/extractions
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://vps-5478319-x.dattaweb.com:3000}
      COOKIE_SECURE: ${COOKIE_SECURE:-false}
    ports:
      - "3000:3000"
    volumes:
      # Bind mount: carpeta física del servidor -> carpeta dentro del contenedor
      # ../data es relativo al docker-compose.yml (o sea ~/apps/sidepp-digital/data)
      - ../data:/data
    restart: unless-stopped
