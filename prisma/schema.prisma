generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Institution {
  id               String            @id @default(cuid())
  name             String?
  cuit             String?           @unique
  address          String?
  city             String?
  state            String?
  country          String?           @default("Argentina")
  responsibleName  String?
  responsibleEmail String?
  responsablePhone String?
  fopidEnabled     Boolean           @default(true)
  createdAt        DateTime?         @default(now())
  updatedAt        DateTime?         @updatedAt
  members          Member[]
  payrollPeriods   PayrollPeriod[]
  userInstitutions UserInstitution[]
  pdfFiles         PdfFile[]
  bankTransfers    BankTransfer[]

  @@map("institutions")
}

model Member {
  id                  String             @id @default(cuid())
  numeroOrden         String?
  numeroMatricula     String?
  fullName            String?
  institucionId       String?
  documentoIdentidad  String?
  nacionalidad        String?            @default("Argentina")
  status              String?            @default("active")
  email               String?
  phone               String?
  address             String?
  city                String?
  state               String?
  postalCode          String?
  country             String?            @default("Argentina")
  membershipStartDate DateTime?
  createdAt           DateTime?          @default(now())
  updatedAt           DateTime?          @updatedAt
  deletedAt           DateTime?
  contributions       ContributionLine[]
  institucion         Institution?       @relation(fields: [institucionId], references: [id], onDelete: Cascade)

  @@unique([documentoIdentidad, institucionId], name: "unique_documento_institution")
  @@unique([fullName, institucionId], name: "unique_fullname_institution")
  @@unique([numeroOrden, institucionId], name: "unique_orden_institution")
  @@unique([numeroMatricula, institucionId], name: "unique_matricula_institution")
  @@map("members")
}

model PayrollPeriod {
  id            String        @id @default(cuid())
  institutionId String?
  month         Int?
  year          Int?
  transferId    String?
  label         String?
  createdAt     DateTime?     @default(now())
  updatedAt     DateTime?     @updatedAt
  transfer      BankTransfer?
  institution   Institution?  @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  pdfFiles      PdfFile[]

  @@unique([institutionId, month, year], name: "uq_period_institution_month_year")
  @@map("payroll_periods")
}

model ContributionLine {
  id            String             @id @default(cuid())
  memberId      String?
  name          String?
  quantity      Int?
  conceptAmount Decimal?           @db.Decimal(18, 2)
  totalRem      Decimal?           @db.Decimal(18, 2)
  status        ContributionStatus @default(PENDING)
  pdfFileId     String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  member        Member?            @relation(fields: [memberId], references: [id], onDelete: Cascade)
  pdfFile       PdfFile?           @relation(fields: [pdfFileId], references: [id], onDelete: SetNull)

  @@map("contribution_lines")
}

model BankTransfer {
  id                 String        @id @default(cuid())
  datetime           DateTime?
  reference          String?
  operationNo        String?
  cbuDestino         String?
  cuentaOrigen       String?
  importe            Decimal       @db.Decimal(18, 2)
  cuitOrdenante      String?
  cuitBenef          String?
  titular            String?
  periodId           String        @unique
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  bufferHash         String?
  banco              String?
  tipoOperacion      String?
  importeATransferir Decimal?      @db.Decimal(18, 2)
  importeTotal       Decimal?      @db.Decimal(18, 2)
  ordenanteNombre    String?
  ordenanteDomicilio String?
  institutionId      String?
  period             PayrollPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)
  institution        Institution?  @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  pdfFiles           PdfFile[]

  @@map("bank_transfers")
}

model PdfFile {
  id               String             @id @default(cuid())
  fileName         String
  storagePath      String?
  periodId         String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  bufferHash       String?            @unique
  concept          String?
  peopleCount      Int?
  totalAmount      Decimal?           @db.Decimal(18, 2)
  type             PdfFileType?
  metadata         Json?
  kind             PdfKind?
  size             Int?
  mimeType         String?
  parsed           Boolean?           @default(false)
  parseErrors      String?
  institutionId    String?
  uploadedBy       String?
  transferId       String?
  contributionLine ContributionLine[]
  period           PayrollPeriod?     @relation(fields: [periodId], references: [id], onDelete: Cascade)
  institution      Institution?       @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  bankTransfer     BankTransfer?      @relation(fields: [transferId], references: [id], onDelete: SetNull)

  @@map("pdf_files")
}

model User {
  id               String            @id @default(cuid())
  email            String            @unique
  name             String?
  password         String
  role             UserRole          @default(LIQUIDADOR)
  isActive         Boolean           @default(true)
  lastLogin        DateTime?
  loginAttempts    Int               @default(0)
  lockedUntil      DateTime?
  resetToken       String?           @unique
  resetExpires     DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  deletedAt        DateTime?
  userInstitutions UserInstitution[]

  @@map("users")
}

model UserInstitution {
  id            String      @id @default(cuid())
  userId        String
  institutionId String
  createdAt     DateTime    @default(now())
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  @@unique([userId, institutionId])
  @@map("user_institutions")
}

enum PdfFileType {
  SUELDO
  FOPID
  AGUINALDO
  COMPROBANTE
}

enum PdfKind {
  LISTADO
  TRANSFER
}

enum ContributionStatus {
  PENDING
  MATCHED
  MISSING
}

enum UserRole {
  ADMIN
  FINANZAS
  LIQUIDADOR
}
