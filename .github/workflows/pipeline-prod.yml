name: Build, Push and Deploy

on:
  push:
    branches: ["main"]

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Build application
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: build/

  notify-build:
    name: Notify Build Status
    needs: build
    runs-on: ubuntu-latest
    if: always()

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:'%s')
          COMMIT_MSG_ESCAPED=$(echo "$COMMIT_MSG" | sed 's/"/\\"/g' | sed "s/'/\\'/g")

          if [ "${{ needs.build.result }}" == "success" ]; then
            COLOR=3066993
            STATUS="‚úÖ SIDEPP-Digital - Build Exitoso"
            DESCRIPTION="**Paso 1/3** - El build de **producci√≥n** finaliz√≥ correctamente.\n\nüì¶ Dependencias instaladas y compilaci√≥n completada sin errores."
          else
            COLOR=15158332
            STATUS="‚ùå SIDEPP-Digital - Build Fallido"
            DESCRIPTION="**Paso 1/3** - El build de **producci√≥n** ha fallado.\n\n‚ö†Ô∏è El pipeline se detuvo. Revisar los logs para identificar el error."
          fi

          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{
              \"embeds\": [{
                \"title\": \"$STATUS\",
                \"description\": \"$DESCRIPTION\",
                \"color\": $COLOR,
                \"fields\": [
                  {\"name\": \"üìù Cambios\", \"value\": \"$COMMIT_MSG_ESCAPED\", \"inline\": false},
                  {\"name\": \"üåø Branch\", \"value\": \"\`${{ github.ref_name }}\`\", \"inline\": true},
                  {\"name\": \"üîó Commit\", \"value\": \"[\`${GITHUB_SHA::7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})\", \"inline\": true},
                  {\"name\": \"üë§ Autor\", \"value\": \"${{ github.actor }}\", \"inline\": true}
                ],
                \"footer\": {\"text\": \"SIDEPP-Digital ‚Ä¢ GitHub Actions\"},
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            $DISCORD_WEBHOOK

  publish:
    name: Build & Push Docker Image
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build/

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image owner lowercase
        id: vars
        run: echo "owner=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_OUTPUT

      - uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ghcr.io/${{ steps.vars.outputs.owner }}/sidepp-digital:latest
            ghcr.io/${{ steps.vars.outputs.owner }}/sidepp-digital:${{ github.sha }}

  notify-publish:
    name: Notify Publish Status
    needs: publish
    runs-on: ubuntu-latest
    if: always()

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:'%s')
          COMMIT_MSG_ESCAPED=$(echo "$COMMIT_MSG" | sed 's/"/\\"/g' | sed "s/'/\\'/g")

          if [ "${{ needs.publish.result }}" == "success" ]; then
            COLOR=3066993
            STATUS="üê≥ SIDEPP-Digital - Imagen Docker Publicada"
            DESCRIPTION="**Paso 2/3** - La imagen Docker se subi√≥ correctamente a GitHub Container Registry.\n\nüì§ Tags publicados:\n‚Ä¢ \`latest\`\n‚Ä¢ \`${GITHUB_SHA::7}\`"
          elif [ "${{ needs.publish.result }}" == "skipped" ]; then
            COLOR=9807270
            STATUS="‚è≠Ô∏è SIDEPP-Digital - Docker Push Omitido"
            DESCRIPTION="**Paso 2/3** - El push de la imagen fue omitido.\n\n‚ö†Ô∏è Un paso anterior fall√≥, revisar notificaciones previas."
          else
            COLOR=15158332
            STATUS="‚ùå SIDEPP-Digital - Docker Push Fallido"
            DESCRIPTION="**Paso 2/3** - Error al publicar la imagen Docker.\n\n‚ö†Ô∏è El pipeline se detuvo. Revisar los logs para identificar el error."
          fi

          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{
              \"embeds\": [{
                \"title\": \"$STATUS\",
                \"description\": \"$DESCRIPTION\",
                \"color\": $COLOR,
                \"fields\": [
                  {\"name\": \"üìù Cambios\", \"value\": \"$COMMIT_MSG_ESCAPED\", \"inline\": false},
                  {\"name\": \"üåø Branch\", \"value\": \"\`${{ github.ref_name }}\`\", \"inline\": true},
                  {\"name\": \"üîó Commit\", \"value\": \"[\`${GITHUB_SHA::7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})\", \"inline\": true},
                  {\"name\": \"üë§ Autor\", \"value\": \"${{ github.actor }}\", \"inline\": true}
                ],
                \"footer\": {\"text\": \"SIDEPP-Digital ‚Ä¢ GitHub Actions\"},
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            $DISCORD_WEBHOOK

  deploy:
    name: Deploy to Prod
    needs: publish
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.PROD_HOST }}
          port: ${{ secrets.PROD_PORT }}
          username: ${{ secrets.PROD_USER }}
          password: ${{ secrets.PROD_PASSWORD }}
          script: |
            cd ~/apps/sidepp-digital/deploy
            docker compose pull
            docker compose up -d
            echo "Deploy completed!"

  notify-deploy:
    name: Notify Deploy Status
    needs: deploy
    runs-on: ubuntu-latest
    if: always()

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:'%s')
          COMMIT_MSG_ESCAPED=$(echo "$COMMIT_MSG" | sed 's/"/\\"/g' | sed "s/'/\\'/g")

          if [ "${{ needs.deploy.result }}" == "success" ]; then
            COLOR=3066993
            STATUS="üöÄ SIDEPP-Digital - Deploy Completado"
            DESCRIPTION="**Paso 3/3** - El deploy a **producci√≥n** finaliz√≥ exitosamente.\n\n‚ú® La nueva versi√≥n est√° disponible en el servidor de producci√≥n."
          elif [ "${{ needs.deploy.result }}" == "skipped" ]; then
            COLOR=9807270
            STATUS="‚è≠Ô∏è SIDEPP-Digital - Deploy Omitido"
            DESCRIPTION="**Paso 3/3** - El deploy fue omitido.\n\n‚ö†Ô∏è Un paso anterior fall√≥, revisar notificaciones previas."
          else
            COLOR=15158332
            STATUS="‚ùå SIDEPP-Digital - Deploy Fallido"
            DESCRIPTION="**Paso 3/3** - Error durante el deploy a **producci√≥n**.\n\nüî• **Acci√≥n requerida**: Verificar conexi√≥n SSH y estado del servidor."
          fi

          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{
              \"embeds\": [{
                \"title\": \"$STATUS\",
                \"description\": \"$DESCRIPTION\",
                \"color\": $COLOR,
                \"fields\": [
                  {\"name\": \"üìù Cambios\", \"value\": \"$COMMIT_MSG_ESCAPED\", \"inline\": false},
                  {\"name\": \"üåø Branch\", \"value\": \"\`${{ github.ref_name }}\`\", \"inline\": true},
                  {\"name\": \"üîó Commit\", \"value\": \"[\`${GITHUB_SHA::7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})\", \"inline\": true},
                  {\"name\": \"üë§ Autor\", \"value\": \"${{ github.actor }}\", \"inline\": true}
                ],
                \"footer\": {\"text\": \"SIDEPP-Digital ‚Ä¢ GitHub Actions\"},
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            $DISCORD_WEBHOOK
